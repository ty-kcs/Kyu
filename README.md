# Kyu (休) - ウェルビーイング支援アプリ MVP

## 概要
現状では、「主観的疲労度」と「客観的表情分析」のズレを可視化し、日本人に多い「まだ頑張れる」を検知するシステム。

## 疲労度の周期性について
「1日（24時間）単位で疲労度の周期が繰り返される」ことを前提としています。
つまり、（少なくとも現状の実装では、）疲労度の予測や分析は「時刻（0.0〜24.0）」のみを特徴量とし、日付や曜日などは考慮していません。
（例えば「15時」の疲労度はどの日でも同じように扱われます。）

## システム構成

### 1. face_analyzer.py
- OpenFaceのAction Units (AU04, AU43) から客観的疲労度を算出
- **AU04** (Brow Lowerer): ストレス・緊張指標
- **AU43** (Eyes Closed): 眠気指標
- 計算式: `Score_obj = 1 + min(6, (w1*AU04 + w2*AU43) * scaling_factor)`(この式はまじチャットGPT作成です。追々ちゃんとしたシステムにします。)

### 2. gpr_model.py
- ガウス過程回帰 (GPR) による24時間疲労度予測
- **特徴量**: 時刻 (0.0 ~ 24.0)
- **ターゲット**: 疲労度 (1-7)
- **客観補正機能**: 主観と客観の乖離が大きい場合、客観値を重視

### 3. main.py
- データ統合・分析・可視化のメインスクリプト
- 主観/客観の乖離分析
- 疲労度タイムライン生成

## セットアップ

### 環境構築 (仮想環境)
1. **Pythonのインストール確認**:
   - Python 3.8以上がインストールされていることを確認してください。
   ```bash
   python --version
   ```

2. **仮想環境の作成**:
   ```bash
   python -m venv venv
   ```

3. **仮想環境のアクティブ化**:
   - macOS/Linux:
     ```bash
     source venv/bin/activate
     ```
   - Windows:
     ```bash
     venv\Scripts\activate
     ```

4. **依存関係のインストール**:
   ```bash
   pip install -r requirements.txt
   ```

### メイン実行
```bash
# 実行
python main.py
```

## データ形式 (response.csv)
一個上のディレクトリにある想定。google formのスプレッドシートと少しカラム名変えたので注意です。（スラックボットであのまま収集する場合、前処理としてcsv変換・カラム名変えるスクリプト必要。）
```csv
Timestamp,user_id,subjective_fatigue,photo_link
2025-01-01 09:00:00,user1,2,https://drive.google.com/...
```

## 出力
- `fatigue_timeline_<user_id>.png`: 疲労度予測グラフ
- コンソール: 乖離分析、不確かさ検出結果

### 客観補正ロジック
日本人は「まだ大丈夫」と主観を過小評価しがち。客観データ (顔のAU) が主観より高い場合、実際はもっと疲れていると判断。

```python
# 客観補正なし
predictor_normal = FatiguePredictor(use_objective_correction=False)

# 客観補正あり (客観70% + 主観30%)
predictor_corrected = FatiguePredictor(
    use_objective_correction=True,
    correction_threshold=2.0,
    correction_weight=0.7
)
```

### 不確かさの活用
GPRの標準偏差が高い時間帯 = データ不足 → 通知を送るべき時間帯として活用。

## 今後やること

### 1:実際に最低限使えるシステムにする

#### 1. ChatGPT APIとの統合（担当: komiyaくん）
- 疲労度データ（主観・客観・タイムスタンプ・ユーザーIDなど）をChatGPT APIに送信し、説得力のあるアドバイスを生成
- ChatGPT APIリクエスト例・Slack通知の実装（`generate_advice`, `send_slack_message`関数）

#### 2. データ収集の自動化
- Slack Botで定期通知（1日4回など）
- 回答データの自動収集・DB保存
- 回答データをリアルタイムでGPRモデルに反映

---

### 2: 顔解析の精度向上と通知の最適化

#### 1. OpenFaceの本格導入(担当:たい)
- モック実装からOpenFaceによる実解析へ移行
- 顔写真アップロード・AUデータ取得・疲労度スコア計算
- `FaceAnalyzer.extract_action_units`の本番化

#### 2. 通知タイミングの最適化（担当: komiyaくん）
- GPRモデルで疲労ピークタイムを特定
- ピークタイムに合わせてSlack通知を送れる仕組みを作る
- `get_high_uncertainty_periods`の拡張

---

### 3: 自動検知と完全自律化（まあ、余裕あったら）

#### 0. 初期アンケートシステムの構築
**ユーザー体験:**
- 初回起動時に生活習慣アンケート（起床/就寝時刻、仕事時間、休憩タイミングなど）に回答
- ChatGPT APIが「疲れ度確率タイムラインのプロトタイプ」を生成
- 1日4回、ゆらぎのあるタイミングで通知が届き、回答することでAIと疲労感覚を同期

**方法:**
- 生活習慣アンケート結果をChatGPT APIに送信して初期タイムラインを生成
- 1日4回の通知（±30分のランダム性）でデータ収集
- 3日程度のデータ蓄積後、GPRモデルを再学習して個人最適化
- データ蓄積完了でフェーズ2へ自動遷移

---

#### 1. 自動通知システムの構築
- 疲労度確率タイムラインが閾値を超えたら自動通知
- 顔写真のみで疲労度推測
- 通知トリガーの追加

#### 2. モデルのオンライン学習（むずそう）
- 新しい回答データでモデルを随時再学習
- モデルドリフト検知・再学習トリガー
- `FatiguePredictor.fit`のオンライン学習対応

#### 3. フェーズ間の自動遷移
- 回答頻度やモデル精度に応じてフェーズ自動切替（データ収集フェーズとアドバイスフェーズ）
- フェーズ管理ロジック追加

**フェーズの定義：**
- **フェーズ1（データ収集期）**: 初期アンケート→1日4回の定期通知→回答データ蓄積（3日程度）。生活習慣から汎用疲れ度タイムラインを生成し、実回答で個人最適化。
- **フェーズ2（最適化期）**: 通知回数を減らし、GPRで予測したピークタイムに絞って通知。顔写真も収集し、ユーザー専用の疲れ顔診断モデルを構築。
- **フェーズ3（自律運用期）**: ユーザは回答義務なし。AIが疲労度タイムラインの閾値超過を検知して自動通知。顔写真のみで客観的疲労を提示し、休息を促す。

**遷移：**
- フェーズ1→2: 一定期間（3日程度）のデータ蓄積完了時
- フェーズ2→3: 予測精度が閾値を超えた時（乖離が小さくなった時）
- フェーズ3→2（逆行）: 抜き打ちフォーム回答で乖離が再び大きくなった時（モデルドリフト検知）
---
